from flask import render_template, request
import os
from detection_app import app
from werkzeug.utils import secure_filename
from detection_app.apk_preprocessor.apk_preprocessing import ApkPreprocessing
from detection_app.data_preprocessor.data_preprocessing import DataPreprocessing
from detection_app.classifier.classifier import Classifier

ALLOWED_EXTENSIONS = {'apk'}

apk_proc = ApkPreprocessing()
data_preprocessor = DataPreprocessing()
classifier = Classifier()


def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS


@app.route("/", methods=["GET", "POST"])
def index():
    if request.method == 'POST':
        file = request.files['file']
        # upload logic here
        if file and allowed_file(file.filename):
            filename = secure_filename(file.filename)
            file.save(filename)
            # call analyze apk
            permissions = apk_proc.get_permissions(filename)
            intents = apk_proc.get_intents(filename)
            features = permissions + intents
            data = data_preprocessor.preprocess(features)
           # print(data.columns)
            pred = classifier.load_predict(data)
            print(pred)

    return render_template('home.html')
